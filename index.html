<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signature Smoother</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; color: #333; background: #f4f4f9; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .control-group { display: flex; flex-direction: column; gap: 0.5rem; }
        label { font-size: 0.85rem; font-weight: 600; color: #666; }
        input[type="range"] { cursor: pointer; }
        canvas { 
            border: 1px solid #ddd; width: 100%; height: auto; border-radius: 8px;
            /* Checkerboard background to show transparency */
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%), linear-gradient(-45deg, #eee 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #eee 75%), linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 20px 20px; background-position: 0 0, 0 10px, 10px 10px, 10px 0;
        }
        .btn { 
            grid-column: span 2; padding: 0.8rem; background: #007bff; color: white; 
            border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem;
        }
        .btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="card">
        <h2 style="margin-top: 0;">Signature Smoother</h2>
        <div class="controls">
            <div class="control-group">
                <label>1. Upload PNG/JPG</label>
                <input type="file" id="upload" accept="image/png, image/jpeg">
            </div>
            <div class="control-group">
                <label>2. Ink Color</label>
                <input type="color" id="inkColor" value="#000000">
            </div>
            <div class="control-group">
                <label>3. Clean Background</label>
                <input type="range" id="sensitivity" min="0" max="1" step="0.01" value="0.7">
            </div>
            <div class="control-group">
                <label>4. Line Thickness</label>
                <input type="range" id="thickness" min="0" max="4" step="1" value="0">
            </div>
            <button class="btn" id="downloadBtn">Download Signature</button>
        </div>
        <canvas id="canvas"></canvas>
    </div>

    <script>
        const upload = document.getElementById('upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        let originalImg = null;

        // Auto-update on slider change
        ['sensitivity', 'thickness', 'inkColor'].forEach(id => {
            document.getElementById(id).oninput = processImage;
        });

        upload.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                originalImg = new Image();
                originalImg.onload = () => {
                    canvas.width = originalImg.width;
                    canvas.height = originalImg.height;
                    processImage();
                };
                originalImg.src = event.target.result;
            };
            reader.readAsDataURL(file);
        };

        function processImage() {
            if (!originalImg) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(originalImg, 0, 0);

            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const sens = parseFloat(document.getElementById('sensitivity').value);
            const thick = parseInt(document.getElementById('thickness').value);
            const ink = document.getElementById('inkColor').value;
            const r = parseInt(ink.slice(1,3), 16), g = parseInt(ink.slice(3,5), 16), b = parseInt(ink.slice(5,7), 16);

            let alphaMap = new Uint8ClampedArray(canvas.width * canvas.height);
            const cutoff = 255 * sens;

            // 1. Thresholding
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                const inverted = 255 - avg;
                alphaMap[i/4] = inverted > cutoff ? Math.min(255, (inverted - cutoff) * (255 / (255 - cutoff))) : 0;
            }

            // 2. Dilation (Thickness)
            if (thick > 0) {
                for (let t = 0; t < thick; t++) {
                    let copy = new Uint8ClampedArray(alphaMap);
                    for (let y = 1; y < canvas.height - 1; y++) {
                        for (let x = 1; x < canvas.width - 1; x++) {
                            const idx = y * canvas.width + x;
                            alphaMap[idx] = Math.max(copy[idx], copy[idx-1], copy[idx+1], copy[idx-canvas.width], copy[idx+canvas.width]);
                        }
                    }
                }
            }

            // 3. Final Render
            for (let i = 0; i < data.length; i += 4) {
                data[i] = r; data[i+1] = g; data[i+2] = b;
                data[i+3] = alphaMap[i/4];
            }
            ctx.putImageData(imageData, 0, 0);
        }

        document.getElementById('downloadBtn').onclick = () => {
            if (!originalImg) return alert("Upload an image first!");
            const link = document.createElement('a');
            link.download = 'signature.png';
            link.href = canvas.toDataURL();
            link.click();
        };
    </script>
</body>
</html>
